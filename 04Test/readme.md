## 테스트 구축하기


 리팩터링을 제대로 하려면 견고한 테스트 스위트( test suite )가 뒷받침 되어야 한다
 
 테스트 작성은 효율을 높여준다

---

### 자가 테스트 코드의 가치

- 개발자들이 코드를 짜는 시간은 크지않고, 보통은 파아하는 시간, 고민하는 시간 및 디버깅에 힘쓴다

---

**모든 테스트를 완전히 자동화하고 그 결과까지 스스로 검사하게 만들자**

---

- 테스트를 자주 수행하는 습관도 강력한 도구가 된다

---

**테스트 스위트는 강력한 버그 검출 도구로, 버그를 찾는 데 걸리는 시간을 대폭 줄여준다**

---

- 테스트를 자동화 하게 되면 생각보다 재밌다????


- 테스트를 작성하기 좋은 시기는 프로그람을 작성하기 전이다
  - 원하는 기능을 추가하기 위해 무엇이 필요한지 고민하게 된다
  - **( 구현보다 인터페이스에 집중하게 된다 )**
  - 이것은 무조건 좋은 것이다!! 
  - TDD!!


- **리팩터링에는 테스트가 반드시 필요하다!** 테스트를 반드시 먼저 작성하라!

---

### 테스트할 샘플 코드

사용자가 생산 계획을 검토하고 도와주는 애플리케이션 : [ 테스트 코드 ](./index.html)

- 생산 계획은 각 지역( province )의 수요( demand )와 가격( price )로 구성된다


- 위 코드의 예시
  - 지역의 생산자( producer ) : 특정 가격( 비용 : 10 )으로 특정 수량( 9 )만큼 생산
  - 수익 : 비용 * 생산량
  - 사용자는 UI 에서 수요, 가격, 생산량 및 비용을 조정하며 총수익확인 가능

  
- **수익, 및 생산 부족분을 계산하는 계산하는 클래스**만 집중적으로 살펴본다

---

**테스트는 UI, 영속성, 외부 서비스와 관련없는 코드부터 본다**

( 테스트는 성격에 따라 분리하는 것이 좋다 )

---

[test]: (./statement/province.mjs)

- 비즈니스 로직 코드
  - 지역 전체 : [ Province ](./statement/province.mjs)
  - 생산자 :[ Producer ](./statement/producer.mjs)
  - Province 에서 인수로 쓸 JSON 데이터 생성  : [ sampleProvinceData ](./statement/sampleProvinceData.mjs)


- 생산자 객체( Producer )에서 전체 지역 객체( _province )를 갯ㅇ신하는 코드가 지저분하다


- 이런 코드를 리팩터링해서 제거하고 싶지만, 그전에 우선! **테스트를 작성해야 한다!**


- [ Test ](./test/index.html) : 테스트를 반드시 수행
  - 테스트는 **실패해야할 상황에서는 반드시 실패하게 만들어야 한다**


- 수많은 테스트를 실행했음에도 실패하는게 없다면 **내 의도와는 다른 방식으로 코드**를 다룰 가능성이 높다

> 이럴 경우 일시적으로 코드에 오류를 주입해보면 된다
> 
> ---
> 
> 예)
> ````javascript
>  get shortfall(){
>    return this._demand - this.totalProduction * 2;
>  }
> ````

- 테스트 프레임워크를 사용하면, 무언가 문제가 생겼을 경우 즉시 알 수 있다
- ( 어느 테스트가 실패했는지 짚어주고, 실패원인을 추론해볼 수 있는 단서까지 제공한다 )

---

**자주 테스트하라. 작성 중인 코드는 최소한 몇 분 간격으로 테스트하고, 적어도 하루에 한번은 전체 테스트를 돌려보자**

---

### 테스트 추가하기

- 이번테스트는 클래스가 하는 일을 모두 살펴보고, 각각 기능에서 오류가 생길 수 있는 조건을 하나씩 테스트

명심할것! **테스트는 위험요인을 중심으로 작성해야 한다**

> 테스트의 목적은 버그를 찾는데 있다
> 
> 단순히 필드를 읽고 쓰는 접근자는 테스트 X
> 
> 테스트를 너무 많이 맨들다보면 필요한 테스트를 놓치게 된다
> 
> **잘못될까봐 걱정되는 영역을 집중적으로 테스트 하라**

---

완벽하게 맨드느라 테스트를 수행하지 못하느니, 불완전한 테스트라도 작성해 실행하는게 낫다

---

[ province , 지역 전체 테스트 ](./test/test.mjs)
- 테스트를 작성할때는 명심할게, 일단 실패하는 테스트( 위의 shortfall 코드처럼 )가 동작하는지 확인하고,
- 오류를 테스트가 걸러내는게 확실하면 해당 테스트를 믿는다!

[ province , 지역 전체 테스트 - beforeEach 적용 ](./test/test.mjs)
- beforeEach 를 사용하는 이유! 모두 똑같은 픽스처( fixture : 고정장치 )에 기초하여 검증을 수행할 수 있기 때문!

[ province , production() 세터 ](./test/test.mjs)
- 일반적으로 setter 는 검사를 잘 하지 않지만, Producer 의 production() 세터는 복잡하기 때문에 테스트한다
- 테스트 패턴을 부르는 이름: 
  - 설정( setup )-실행( exercise )-검증( verify )
  - 조건( given )-발생( when )-결과( then )
  - 준비( arrange )-수행( act )-단언( assert )


---

### 경계 조건 검사하기

- 지금까지의 테스트는 모두 꽃길( happy path )상황이었다
- 그러나 이 범위를 벗어나는 경계 지점에서 어떤 문제가 생기는지 작성하면 좋다

[ no producers , producers 컬렉션이 비었을 경우 ](./test/test.mjs)

[ negative demand , 수요가 마이너스일 경우 ](./test/test.mjs)
- 해당 테스트를 수행할때,
  - 수요가 음수일때, 수익이 음수가 나오는게 말이 되는가?
  - 최솟값은 무조건 0 이어야 하지 않나?
  - 따라서, setter 에 음수가 전달되면, 에러 or 0 으로 최솟값을 설정해야 하는것 아닌가?


- 이런 물음이 테스트할때 나와야한다!
  - **문제가 생길 가능성이 있는 경계 조건을 생각해보고 그 부분을 집중적으로 테스트하자!!**

[ empty string demand , 수요가 비어있을 경우 ](./test/test.mjs)
- 해당 테스트는 UI 로부터 문자열을 전달받기 때문에, 필드가 비어있을지,
- 내가 의도한대로 잘 처리되는지도 테스트 해야한다.

---

**의도적으로 작성한 프로그램을 망가뜨려보는것이 테스트다!**

---

[ string for producers , producers 가 문자열일 경우 ](./test/test.mjs)
- 이런 상황일 경우, 프로그람을 어떻게 짜는게 효율적일까?
  - 유효성 검사( validation check )를 할 수 있게 짤 수도 있고,
  - 의미 있는 오류메시지를 출력할 수도 있고( ...is not a function 대신... )
  - 아니면 producers = [] 로 할 수도 있다

  
- 그런데 유효성 검증 코드가 너무 많으면, 다른곳에서 검증된 코드를 또다시 검증하여 오히려 문제가 될 수도 있다


- 다만, **JSON 인코딩 요청처럼 외부에서 들어온 입력 객체는 유효한지 확인해봐야한다**


- 리팩터링은 겉보기 동작에 영향을 주지 않아야한다
  - 이런 오류는 겉보기 동작에 해당되지 않는다


---

**어짜피 모든 버그를 잡아낼 수는 없다고 생각하여 테스트를 작성하지 않는다면 대다수의 버그를 잡을 수 있는 기회를 날리는 셈이다**

---

- 테스트를 하기위한 많은 기법들이 있지만, 너무 빠져들 필요는 없다
  - ( 너무 많이 작성하다보면 너무 의욕이 떨어져 하나도 작성하지 않을 위험도 있기 때문에... )


- 따라서, **위험한 부분에 집중하는게 좋다**


- **테스트가 모든 버그를 걸러주지는 못해도, 안심하고 리팩터링할 수 있는 보호막은 되어준다!!**


- 리팩터링하면서 프로그람을 더 깊게 이해하게 되면, 더많은 버그를 찾게 되고 계속 테스트를 추가 및 수정하게 된다!

---

### 마무리

- 이런 단위 **테스트( unit test )**는 코드의 작은 영역만을 대상으로 빠르게 실행되도록 설계된 테스트다


- **단위 테스트**는 자가 테스트 코드의 핵심이다!


- 다른 프로그라밍 활동처럼 테스트도 반복적으로 진행해야 한다


- 실력이 뛰어나거나, 운이 좋지않는한, 완벽한 테스트를 할 수는 없다


- 버그를 발견하는 즉시, 명확히 **버그를 잡아내는 테스트부터 작성**하는 습관을 들이자!!

---

**버그 리포트를 받으면 가장 먼저 그 버그를 드러내는 단위 테스트부터 작성하자!!**

---